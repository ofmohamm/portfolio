---
// SmoothScroll.astro - v3.5
// Smooth scroll with Lenis + soft section snapping
---

<script>
  import Lenis from '@studio-freight/lenis';

  function initSmoothScroll() {
    // Check for reduced motion preference
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (prefersReducedMotion) return;

    // Initialize Lenis
    const lenis = new Lenis({
      duration: 1.2,
      easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)), // Ease out expo
      direction: 'vertical',
      gestureDirection: 'vertical',
      smooth: true,
      smoothTouch: false, // Disable on touch devices (native feels better)
      touchMultiplier: 2,
    });

    // Add lenis class to html element
    document.documentElement.classList.add('lenis');

    // Section snap logic
    const sections = document.querySelectorAll('.snap-section');
    let isSnapping = false;
    let snapTimeout: number;

    lenis.on('scroll', ({ scroll, velocity }: { scroll: number; velocity: number }) => {
      // Only snap when velocity is low (user stopped scrolling)
      if (Math.abs(velocity) < 0.5 && !isSnapping) {
        clearTimeout(snapTimeout);

        snapTimeout = window.setTimeout(() => {
          const viewportHeight = window.innerHeight;

          sections.forEach((section) => {
            const sectionTop = (section as HTMLElement).offsetTop;
            const distanceToTop = Math.abs(scroll - sectionTop);
            const threshold = viewportHeight * 0.15; // 15% threshold

            // Snap if within threshold
            if (distanceToTop < threshold && distanceToTop > 10) {
              isSnapping = true;
              lenis.scrollTo(sectionTop, {
                duration: 0.6,
                onComplete: () => {
                  isSnapping = false;
                },
              });
            }
          });
        }, 150); // Debounce
      }
    });

    // Animation loop
    function raf(time: number) {
      lenis.raf(time);
      requestAnimationFrame(raf);
    }

    requestAnimationFrame(raf);

    // Expose lenis for nav links
    (window as any).lenis = lenis;

    // Smooth scroll to section on nav click
    document.querySelectorAll('a[href^="#"]').forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const target = document.querySelector(link.getAttribute('href') || '');
        if (target && (window as any).lenis) {
          (window as any).lenis.scrollTo(target, { duration: 1 });
        }
      });
    });
  }

  // Initialize on page load and navigation
  initSmoothScroll();
  document.addEventListener('astro:page-load', initSmoothScroll);
</script>

<style is:global>
  /* Smooth scroll CSS */
  html.lenis {
    height: auto;
  }

  .lenis.lenis-smooth {
    scroll-behavior: auto;
  }

  .lenis.lenis-smooth [data-lenis-prevent] {
    overscroll-behavior: contain;
  }
</style>
